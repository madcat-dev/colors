#!/usr/bin/env bash

# Initialise
BASE="$(realpath `dirname "$0"`)"
TEMPLATES="$BASE/templates"
AVAILABLE=( $(ls $BASE/schemes) )
CACHE="$HOME/.cache/colors"
DIFF=$(date '+%s')

source "$BASE/lib/colors.sh"
source "$BASE/lib/core-lib.sh"


USAGE=$(cat <<- ENDDATA
Usage: ${0} [theme] [install] [ARGS...]
  ARGS:
    --color|-c index #color 
                        - set custom theme color by index

    --saturation|-s value
                        - change all colors intensity by a given value

    --relative-saturation|-S
                        - change 8..15 colors intensity relatively base colors.
                          This function forcibly changes the color relative to 
                          the main one. The change value can be set in the 
                          BRIGHTNEST variable, default: 10.
                          Color '0' is excluded in modifier list

    --black|-b value    - сhanging color 0 (black) by increasing the percentage
                          of background intensity by a given value.
                          This function using original black color

    --font|-f "font"    - set base font, example "Noto Sans 11"
                          (replace GTK_FONT_NAME from config file)
                    
    --config|-C "path"  - use external config from path
                          default use config.GTK_THEME_NAME if exists  

    --image|-I "path"   - generate new color theme from image

    --set-bg [fade height (px)]
                        - set background wallpaper (feh use)
                          picture must be specified in the --image parameter

    --light             - gtk application prefer light theme
    --dark              - gtk application prefer dark theme
    
    --short             - short preview color scheme
    --purge             - clear cache

    --help|-h           - print this usage
    --list|-l           - show a list of available schemes 
    --cls|-             - theme preview without extended configs

Order of applying modifiers:
    - get theme from image (if given)
    - load color scheme (if given)
    - apply saturation
    - set special colors value
    - load preselected config or default
    - aplly dark/light theme mode
    - apply black-color modifier (if given)
    - apply custom colors values
    - apply brightnest of relative saturation (always)

Available schemes:
    \033[33m$(echo $(ls `dirname "$0"`/schemes))\033[0m
ENDDATA
)





mkdir -p "$CACHE" > /dev/null 2>&1
source "$BASE/config" > /dev/null 2>&1

declare -A _colors=()

# Restore current color scheme
CURRENT="$CACHE/theme.$(hostname)"

echo -e "declare -A COLOR\nexport COLOR=(" > $CURRENT
for i in ${COLOR_KEYS[@]}; do
    [[ $(int $i) ]] && \
        cl=$(xrdbq "color$i") || cl=$(xrdbq "*.$i")

    [[ ${cl} ]] && echo -e "\t[$i]=\"$cl\"" >> $CURRENT
done
echo -e ")" >> $CURRENT

# Load main config
[[ -e "$BASE/config" ]] && source "$BASE/config"


# Parse command-line args
while [ -n "$1" ]; do
	case "${1}" in
    install)
        INSTALL=yes
        ;;

    --color|-c)
        [[ ! $(at "${2}" ${COLOR_KEYS[@]}) ]] && \
            echo -e "\033[31mInvalid parameter '${2}' from ${1} argument\033[0m" && exit 1

        [[ ! $(rgb "${3}" --no-kill) ]] && \
            echo -e "\033[31mInvalid color '${3}' from ${1} argument\033[0m" && exit 1
        
        _colors[${2}]="${3}"
        shift; shift
        ;;

    --saturation|-s)
        VAL=$(int ${2:-"undefined"})
        [[ ! $VAL || $VAL -gt 100 || $VAL -lt -100 ]] && \
            echo -e "\033[31mInvalid parameter '${2}' from ${1} argument\033[0m" && exit 1

        SATURATION=$VAL
        shift
        ;;

    --relative-saturation|-S)
        RELATIVE_SATURATION=true
        ;;

    --black|-b)
        VAL=$(int ${2:-"undefined"})
        [[ ! $VAL || $VAL -gt 100 || $VAL -lt -100 ]] && \
            echo -e "\033[31mInvalid parameter '${2}' from ${1} argument\033[0m" && exit 1

        _BLACK_VALUE=$VAL
        shift
        ;;

    --font|-f)
        [[ ! ${2} || ${2:0:1} == "-" ]] && \
            echo -e "\033[31mInvalid parameter '${2}' from ${1} argument\033[0m" && exit 1

        _GTK_FONT_NAME="${2}"
        shift
        ;;

    --config|-C)
        [[ ! -e "${2/\~/$HOME}" ]] && \
            echo -e "\033[31mInvalid '${2/\~/$HOME}' config file\033[0m" && exit 1

        CONFIG="${2/\~/$HOME}"
        shift
        ;;

    --image|-I)
        [[ ! -e "${2/\~/$HOME}" ]] && \
            echo -e "\033[31mImage file '${2/\~/$HOME}' not existing\033[0m" && exit 1

        IMAGE="${2/\~/$HOME}"
        shift
        ;;

    --set-bg)
        VAL=$(int ${2})
        [[ $VAL ]] && shift

        SET_BACKGROUND=${VAL:-80}
        ;;

    --light)
        GTK_APPLICATION_PREFER_DARK_THEME=0
        ;;
    --dark)
        GTK_APPLICATION_PREFER_DARK_THEME=1
        ;;

    --short)
        export SHORT_PREVIEW=true
        ;;
    --purge)
        rm -rf $CACHE/config.*
        rm -rf $CACHE/theme.*
        ;;
	--help|-h)
		echo -e "$USAGE"
        exit 0
		;;
    --list|-l)
        echo -e "${AVAILABLE[@]}"
        exit 0
        ;;
    --cls|-)
        CLEAN_THEME_PREVIEW=true
        ;;
	*)
		NAME="${1/\~/$HOME}"
        [[ ${NAME:0:1} == "-" ]] && \
            echo -e "\033[31mInvalid parametr '$NAME'!!!\033[0m\n" && exit 1
		;;
	esac
    shift
done


# Select prefered brightnest variant
LIGHT=true
BRIGHT_VARIANT=""
if [[ ${GTK_APPLICATION_PREFER_DARK_THEME:-1} == 1 ]]; then
    LIGHT=false
    BRIGHT_VARIANT="-dark"
fi

# Get theme from image file
if [[ ${IMAGE} ]]; then
    [[ ! -e ${IMAGE} ]] && \
        echo -e "\033[31mImage file '${IMAGE}' not existing\033[0m" && exit 1

    new_theme=$(mktemp -u "$CACHE/theme.XXXXXXXXX")
    $BASE/bin/wal.py "${IMAGE}" ${LIGHT} "$new_theme"

    NAME="$new_theme"
fi

# Resolve colors theme name
NAME=${NAME:-${CURRENT}}

if [[ ! -f "$NAME" ]]; then
	NAME="$BASE/schemes/$NAME"

	[[ ! -f "${NAME}" ]] && \
		echo -e "\033[31mColor theme '$NAME' not existing!\033[0m\n" && exit 1
fi

# Load color theme
unset      COLOR
declare -A COLOR
source    "$NAME"
rgb_normalize --normalise-clear-colors

ORIGIN_BLACK=${COLOR[0]}


# Preview without external config
[[ ${CLEAN_THEME_PREVIEW} ]] && preview_theme


# Set saturation
if [[ ${SATURATION} ]]; then
    for i in {0..15}; do
        COLOR[$i]=$(saturation "${COLOR[$i]}" $SATURATION)
    done
fi


# Set specials colors
[[ ${COLOR[foreground]} ]]              || COLOR[foreground]=${COLOR[15]:-#FFFFFF}
[[ ${COLOR[background]} ]]              || COLOR[background]=${COLOR[0]:-#000000}
[[ ${COLOR[cursor]} ]]                  || COLOR[cursor]=${COLOR[8]:-#FFFFFF}
[[ ${COLOR[highlight]} ]]               || COLOR[highlight]=${COLOR[9]:-#FF0000}
[[ ${COLOR[url_color]} ]]               || COLOR[url_color]=${COLOR[12]:-#0000FF}
[[ ${COLOR[selection_foreground]} ]]    || COLOR[selection_foreground]=${COLOR[0]:-#000000}
[[ ${COLOR[selection_background]} ]]    || COLOR[selection_background]=${COLOR[7]:-#FFFFFF}


# Load main config (theme config parameters is replaced by this)
if [[ -e ${CONFIG} ]]; then
    source $CONFIG
else
    [[ -e "$BASE/config" ]] && source "$BASE/config"
fi


# Replace defined font and check it
[[ ${_GTK_FONT_NAME} ]] && \
    GTK_FONT_NAME="${_GTK_FONT_NAME}"


# Set color 0 from background color
[[ ${_BLACK_VALUE} ]] && \
    BLACK_VALUE="${_BLACK_VALUE}"

if [[ ${BLACK_VALUE} ]]; then
    COLOR[background]=${ORIGIN_BLACK:-#010101}
    COLOR[0]=$(saturation "${COLOR[background]}" $BLACK_VALUE)
fi


# Replace defined colors
for i in ${!_colors[@]}; do
    COLOR[$i]=${_colors[$i]}
done

# Set brightnest
for i in {1..7}; do
    j=$(echo "$i + 8" | bc -s)
    [[ ${COLOR[$i]} == ${COLOR[$j]} || ${RELATIVE_SATURATION} ]] && \
        COLOR[$j]=$(saturation "${COLOR[$i]}" ${BRIGHTNEST:-10})
done


# Default gtk-theme
GTK_THEME_NAME="FlatColor"
# Default icon-theme with colors modified variant
GTK_ICON_THEME_NAME="Tela-${COLOR[cursor]:-default}${BRIGHT_VARIANT}"


# Preview with external config
rgb_normalize --normalise-modified-colors
[[ ! ${CLEAN_THEME_PREVIEW} ]] && preview_theme


#
# Install theme files
#

# Set background image
if [[ ${SET_BACKGROUND} ]]; then
    [[ ! ${IMAGE} ]] && \
        echo -e "\033[31mPlease specify the image first with --image\033[0m" && exit 1

    $BASE/bin/set-bg "$IMAGE" --fade-top ${SET_BACKGROUND:-80} \
        --fade-color $([[ ${BRIGHT_VARIANT} ]] && echo "#000000FF" || echo "#FFFFFFFF")
fi

[[ ! ${INSTALL} ]] && exit 0

echo -e "-- Install theme '${NAME/$HOME/\~}'\n"

# Install XRDB colors
echo -e "[ ] Install xrdb colors"
DEST="$CACHE/xrdb"

install_theme "$TEMPLATES/xrdb" "$DEST"
xrdb -merge "$DEST" && \
    echo -e "[+] Xrdb colors installed"


# Install TERMINALS colors
echo -e "[ ] Install terminals colors"

# kitty terminal
install_theme "$TEMPLATES/kitty.conf" "$CACHE/kitty.colors.conf"

# xfce-termanal
install_theme "$TEMPLATES/xfce4-terminal.theme" "$CACHE/xfce4-terminal.theme"

$BASE/bin/xfce-color-switch "$CACHE/xfce4-terminal.theme" && \
    echo -e "[+] Terminals colors installed"


# Install ROFI colors
echo -e "[ ] Install rofi colors"
install_theme "$TEMPLATES/rofi.rasi" "$CACHE/colors.rasi"
echo -e "[+] Rofi colors installed"


# Install GTK colors
CFG="$HOME/.config"

echo -e "[ ] Install gtk 2.0 colors"
TMPL="$TEMPLATES/gtk-2.0"

install_theme "$TMPL/colorsrc"      "$CFG/gtk-2.0/colorsrc"
install_theme "$TMPL/gtkrc"         "$CFG/gtk-2.0/gtkrc"
echo -e "[+] Gtk colors 2.0 installed"
echo -e "    Append 'export GTK2_RC_FILES=\"\$HOME/.config/gtk-2.0/gtkrc\"'"
echo -e "    to your .profile or replace ~/.gtkrc-2.0 by gtkrc source"

echo -e "[ ] Install gtk 3.0 colors"
install_theme "$TEMPLATES/gtksourceview.xml" \
    "$HOME/.local/share/gtksourceview-3.0/styles/gtksourceview.xml"

TMPL="$TEMPLATES/gtk-3.0"
install_theme "$TMPL/settings.ini"  "$CFG/gtk-3.0/settings.ini"
install_theme "$TMPL/colors.css"    "$CFG/gtk-3.0/colors.css"
install_theme "$TMPL/gtk.css"       "$CFG/gtk-3.0/gtk.css"
echo -e "[+] Gtk colors 3.0 installed"

echo -e "[ ] Install gtk 4.0 colors"
install_theme "$TEMPLATES/gtksourceview.xml" \
    "$HOME/.local/share/gtksourceview-4/styles/gtksourceview.xml"

TMPL="$TEMPLATES/gtk-4.0"
install_theme "$TMPL/settings.ini"  "$CFG/gtk-4.0/settings.ini"
echo -e "[+] Gtk colors 4.0 installed"


# Install GTK theme
if [[ "${GTK_THEME_NAME}" && ! -e "$HOME/.themes/${GTK_THEME_NAME}" ]]; then
    echo -e "[ ] Install gtk theme '${GTK_THEME_NAME}'"

    [[ ! -e "$BASE/themes/${GTK_THEME_NAME:-Empty}.tar.gz" ]] && \
        echo -e "\e[31m[!] Theme '${GTK_THEME_NAME}' not existing\e[0m" && \
        exit 1

    mkdir -p "$HOME/.themes" > /dev/null 2>&1
    tar -xzf "$BASE/themes/${GTK_THEME_NAME}.tar.gz" -C "$HOME/.themes"

    echo -e "[+] Gtk theme '${GTK_THEME_NAME}' installed"
fi


# Install Icons theme
SRC_GTK_ICON_THEME_NAME=( ${GTK_ICON_THEME_NAME/\-\#/ } )

if [[ "${SRC_GTK_ICON_THEME_NAME}" && ! -e "$HOME/.icons/${GTK_ICON_THEME_NAME:-unknown}" ]]; then
    echo -e "[ ] Install icons theme '${GTK_ICON_THEME_NAME}'"

    [[ ! -e "$BASE/icons/${SRC_GTK_ICON_THEME_NAME:-Empty}.tar.gz" ]] && \
        echo -e "\e[31m[!] Icons theme '${GTK_ICON_THEME_NAME}' not existing\e[0m" && \
        exit 1

    THEME_DIR="$HOME/.icons/${SRC_GTK_ICON_THEME_NAME}"

    mkdir -p "$HOME/.icons" > /dev/null 2>&1
    rm   -rf "$THEME_DIR"   > /dev/null 2>&1
    tar -xzf "$BASE/icons/${SRC_GTK_ICON_THEME_NAME}.tar.gz" -C "$HOME/.icons"

    [[ ! -e "$THEME_DIR" ]] && \
        echo -e "\e[31m[!] Icons theme '${SRC_GTK_ICON_THEME_NAME}' not prepeared\e[0m" && \
        exit 1

    if [[ "$SRC_GTK_ICON_THEME_NAME" != "$GTK_ICON_THEME_NAME" ]]; then
        ERROR=""

        if [[ ${BRIGHT_VARIANT} ]]; then
            sed  -i "s/#565656/#aaaaaa/g" \
                "${THEME_DIR}"/{16,22,24}/actions/*.svg || ERROR=true

            sed  -i "s/#727272/#aaaaaa/g" \
                "${THEME_DIR}"/{16,22,24}/{places,devices}/*.svg || ERROR=true

            sed  -i "s/#555555/#aaaaaa/g" \
                "${THEME_DIR}"/symbolic/{actions,apps,categories,devices,emblems,emotes,mimetypes,places,status}/*.svg || \
                ERROR=true

            [[ ${ERROR} ]] && \
                echo -e "\033[31m  - Dark brightnest variant is not applyed\033[0m" || \
                echo -e "  - Dark brightnest variant is applyed"
        fi

        if [[ ! ${ERROR} ]]; then
            sed  -i "s/#5294E2/${COLOR[cursor]}/gi" \
                "${THEME_DIR}"/scalable/places/default-*.svg || ERROR=true

            sed  -i "s/#66bcff/$(saturation "${COLOR[cursor]}" +10)/gi" \
                "${THEME_DIR}"/scalable/places/default-*.svg || ERROR=true

            sed  -i "s/#b29aff/$(saturation "${COLOR[cursor]}" +20)/gi" \
                "${THEME_DIR}"/scalable/places/default-*.svg || ERROR=true

            sed  -i "s/#5294E2/${COLOR[cursor]}/gi" \
                "${THEME_DIR}"/16/places/folder*.svg || ERROR=true

            [[ ${ERROR} ]] && \
                echo -e "\033[31m  - Folder colors variant ${COLOR[cursor]} is not applyed\033[0m" || \
                echo -e "  - Folder colors variant ${COLOR[cursor]} is applyed"
        fi

        if [[ ! ${ERROR} ]]; then
            mv "$THEME_DIR" "$HOME/.icons/$GTK_ICON_THEME_NAME" || ERROR=true
        fi

        [[ ${ERROR} ]] && \
            echo -e "\e[31m[-] Icons theme '${SRC_GTK_ICON_THEME_NAME}' not installed\e[0m" && \
            exit 1
    fi

    echo -e "[+] Icons theme '${GTK_ICON_THEME_NAME}' installed"
fi


# Store Shell colors
DEST="$CACHE/colors.sh"
echo -e "[ ] Store shell colors theme '${DEST/$HOME/\~}'"

echo -e "# Shell colors" >  "$DEST"
echo -e ""               >> "$DEST"

for i in ${COLOR_KEYS[@]}; do
    [[ $(int $i) ]] && \
        echo -e "color$i='${COLOR[$i]}'" >> "$DEST" || \
        echo -e "color_$i='${COLOR[$i]}'" >> "$DEST"
done

echo -e "[+] Shell colors theme stored to '${DEST/$HOME/\~}'"


# Store telegram theme
echo -e "[ ] Store telegram colors theme"
$BASE/bin/telegram-palette-gen \
    --palette  "$CACHE/colors.sh" \
    --template "$TEMPLATES/colors.tpg-constants"
echo -e "[+] Telegram colors theme is stored"


# Save last config
KEYS=(
    GTK_THEME_NAME 
    GTK_ICON_THEME_NAME
    GTK_FONT_NAME
    GTK_CURSOR_THEME_SIZE
    GTK_TOOLBAR_STYLE
    GTK_TOOLBAR_ICON_SIZE
    GTK_BUTTON_IMAGES
    GTK_MENU_IMAGES
    GTK_DECORATION_LAYOUT    
    GTK_ENABLE_EVENT_SOUNDS
    GTK_ENABLE_INPUT_FEEDBACK_SOUNDS
    GTK_XFT_ANTIALIAS
    GTK_XFT_HINTING
    GTK_XFT_HINTSTYLE
    GTK_XFT_RGBA
)

f=$(mktemp "$CACHE/config.XXXXXXXXX")

echo "#!/usr/bin/env bash" > "$f"

for i in ${KEYS[@]}; do
    value="${!i}"
    [[ ${value} ]] && echo "$i=\"$value\"" >> "$f"
done

echo "# colors" >> "$f"
for i in ${!COLOR[@]}; do
    echo "COLOR[$i]=\"${COLOR[$i]}\"" >> "$f"
done

echo -e "[+] Your configuration stored at '${f/$HOME/\~}' file"

# Restart wm
bspc wm -r

DIFF=$((`date '+%s'` - $DIFF))
echo -e ""
echo -e "\033[32mCompleted with $(displaytime $DIFF)...\033[0m"
